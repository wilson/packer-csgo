{
  "variables": {
    "steam_token": "{{env `STEAM_TOKEN`}}",
    "rcon_password": "{{env `RCON_PASSWORD`}}"
  },
  "builders": [{
    "profile": "default",
    "type": "amazon-ebs",
    "region": "us-east-2",
    "subnet_filter": {
      "filters": {
        "tag:Name": "public-2a"
      },
      "most_free": true,
      "random": false
    },
    "source_ami_filter": {
      "filters": {
        "virtualization-type": "hvm",
        "name": "ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*",
        "root-device-type": "ebs"
      },
      "owners": ["099720109477"],
      "most_recent": true
    },
    "instance_type": "c5d.xlarge",
    "ebs_optimized": true,
    "ssh_username": "ubuntu",
    "ssh_interface": "public_ip",
    "ami_name": "Ubuntu Counter-Strike {{isotime | clean_resource_name | upper}}",
    "launch_block_device_mappings": [
      {
        "device_name": "/dev/sda1",
        "volume_size": 20,
        "volume_type": "gp2",
        "encrypted": true,
        "delete_on_termination": true
      }
    ],
    "ami_block_device_mappings": [
      {
        "device_name": "/dev/sdb",
        "virtual_name": "ephemeral0"
      }
    ],
    "tags": {
      "OS_Version": "Ubuntu",
      "Release": "18.04",
      "Base_AMI_Name": "{{ .SourceAMIName }}",
      "Game": "CS:GO"
    }
  }],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "export DEBIAN_FRONTEND=noninteractive",
        "sudo -E apt-get update",
        "sudo -E apt-get dist-upgrade -y",
        "sudo -E apt-get install -y --no-install-recommends --no-install-suggests screen lib32stdc++6 lib32gcc1 wget ca-certificates",
        "sudo -E apt-get clean autoclean",
        "sudo -E apt-get autoremove -y"
      ]
    },
    {
      "type": "file",
      "source": "./files/steam_bootstrap.sh",
      "destination": "/tmp/"
    },
    {
      "type": "shell",
      "environment_vars": [
        "STEAM_TOKEN={{user `steam_token`}}",
        "RCON_PASSWORD={{user `rcon_password`}}"
      ],
      "inline": [
        "sudo mv /tmp/steam_bootstrap.sh /root/",
        "sudo mkdir -p /steam",
        "sudo useradd -m steam",
        "echo '/dev/nvme1n1 /steam ext4 defaults,nofail,discard 0 2' | sudo tee --append /etc/fstab"
      ]
    }

  ]
}
